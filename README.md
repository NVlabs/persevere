[![NVIDIA Source Code License](https://img.shields.io/badge/license-NSCL-blue.svg)](https://github.com/NVlabs/perp-fail-severity/blob/main/LICENSE.md)
![Python 3.9](https://img.shields.io/badge/python-3.9-green.svg)

# Perception Failure Severity Estimation

![Header](/images/header.png)

## Requirements

- Python 3.9
- [Poetry >1.2](https://python-poetry.org/) (you can install it following [this guide](https://python-poetry.org/docs/#osx--linux--bashonwindows-install-instructions))

| :warning: WARNING          |
|:---------------------------|
| The repository is under heavy development, be patient...      |

## Setup

### Setting up nuPlan

To run the code you need to install the [nuPlan dataset](https://www.nuscenes.org/nuplan).
At the moment only the mini version is required.
Follow [this guide](https://github.com/motional/nuplan-devkit/blob/master/docs/dataset_setup.md) to download and install the dataset.

This project relies on the environment variables to find the dataset.
In your `~/.bashrc` (or equivalent), add

```sh
export NUPLAN_DATA_ROOT="$HOME/datasets/nuplan/dataset"
export NUPLAN_MAPS_ROOT="$HOME/datasets/nuplan/dataset/maps"
export NUPLAN_EXP_ROOT="$HOME/datasets/nuplan/exp"
```

replacing the path with the one you used.

### Setting up the codebase

In a folder of your choice, run the following commands:

- Clone this project

```sh
git clone https://github.com/NVlabs/perp-fail-severity.git
```

- Clone Trajectron++

```sh
git clone xxxxxxxxxxxxxxxxxxxxxx
git checkout severity-estimation
```

- NuPlan (custom)

```sh
git clone xxxxxxxxxxxxxxxxxxxxxx
git checkout severity-estimation
```

- Install all dependencies (it might take a while)

```sh
cd severity-estimation
poetry install
```

This will set up the virtual environment with everything you need to run the code.

## Run

```sh
poetry run python3 main.py
```

To generate the plots and run the scenario visualization run

```sh
poetry run python3 viz.py experiments/2021-07-01_15-00-00 --nuboard
```

where `experiments/2021-07-01_15-00-00` is the path to the experiment folder.

### Profiling

To profile the code run `poetry run python3 -m cProfile -o main.prof main.py`, then read the profile outputs with `poetry run python3 -m pstats main.prof`.

## Configuration

The configuration is done through the `configs/config.yaml` file.

### Scenarios

The most important part is the `scenarios` section, where you can specify which scenarios you want to run.
There are two modes you might want to run the code: _by scenario type_ or _by scenario name (token)_.

#### By scenario type

To run the code by scenario type, you need to specify the `scenario_types` and `limit_scenarios_per_type` fields in the `scenarios` section.

```yaml
scenarios:
  scenario_types:
    - starting_left_turn
    - starting_right_turn
    - traversing_intersection
    - starting_unprotected_cross_turn
    - following_lane_with_slow_lead
    - stopping_with_lead
  limit_scenarios_per_type: 3
```

#### By scenario name (token)

It is also possible to specify a list of scenarios, or example:

```yaml
scenarios:
  -
    type: chaning_lane_to_left
    log: 2021.06.07.18.53.26_veh-26_00005_00427
    name: a59a8c3490f154e2
  -
    type: chaning_lane_to_left
    log: 2021.06.08.14.35.24_veh-26_02555_03004
    name: 19e8f24c7a975b40
  -
    type: on_intersection
    log: 2021.05.12.22.00.38_veh-35_01008_01518
    name: 69e109f6e2a85ab4
```

### Failures

At the moment the failures are specified in the `main.py` file.
The class `FaultInjectionManager` takes as input a list of failures and takes care of injecting the failures in each scenario.

Each failure mode act on specific agents specified in the file `/configs/failures/autogenerated.yaml` (for HJ reachability based choice) or `/configs/failures/handpicked.yaml` (for a previous manual selection).
Which of the two files is used is specified in the `configs/config.yaml` file.

## Additional tasks

### Auto-formatter

This code is formatted with [Black](https://github.com/psf/black) (automatically installed).
You can format the code from your preferred IDE (e.g., VSCode), or, alternatively, you can run

```sh
poetry run poe format
```

to format all files in the project.

> **Please**: before pushing to git, make sure the project is properly formatted.

### Pre-commit hooks

This repository uses [pre-commit](https://pre-commit.com/) to make sure the code satisfies basic best practices.
To see/edit the hooks please read [pre-commit config file](.pre-commit-config.yaml).
When you clone the repository, the hooks are not automatically enabled, to do so run

```sh
poetry run pre-commit install
```

from now on, all the hooks will automatically execute every time you try to push.
If any of the hooks fail, the code will not be pushed.

If you want to manually run all pre-commit hooks on a repository, run `poetry run pre-commit run --all-files`.
This will check that staged and committed files are compliant.

## FAQ

- To use nuBoard from a remote machine you might need to setup port forwarding. On your machine run `ssh -NfL localhost:5006:localhost:5006 username@XXXXX.com`.
- To omit debug log, run `export LOGURU_LEVEL=INFO` in the terminal session

## Licence

The source code is released under the [NSCL licence](https://github.com/NVlabs/perp-fail-severity/blob/main/LICENSE.md). The preprocessed dataset and pretrained models are under the [CC BY-NC-SA 4.0 licence](https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode).